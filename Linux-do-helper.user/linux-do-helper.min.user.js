// ==UserScript==
// @name         Linux.do 社区助手
// @namespace    http://tampermonkey.net/
// @version      1.0.1
// @description  为 Linux.do 添加快捷评论和回到顶部
// @author       jpzuo
// @match        https://linux.do/*
// @grant        none
// @run-at       document-end
// ==/UserScript==

!function(){"use strict";const e="linuxdo_quick_comments",t="40px",n=["button.btn-primary.create",'button[aria-label*="\u56de\u590d"]',".topic-footer-main-buttons button.create","#topic-footer-buttons button.create","button.reply"],o=[".d-editor-input","textarea.d-editor-input","#reply-control textarea",'textarea[aria-label*="\u8bc4\u8bba"]'],r=["#reply-control button.btn-primary.create","button.btn-primary.create",'button[aria-label*="\u53d1\u9001"]',".submit-panel button.create"];class a{constructor(){this.comments=this.load()}load(){try{return JSON.parse(localStorage.getItem(e)||"[]")}catch(e){return console.error("\u52a0\u8f7d\u8bc4\u8bba\u5931\u8d25:",e),[]}}save(){try{localStorage.setItem(e,JSON.stringify(this.comments))}catch(e){console.error("\u4fdd\u5b58\u8bc4\u8bba\u5931\u8d25:",e)}}add(e){const t=e&&e.trim();return!!t&&(this.comments.push({id:Date.now(),text:t}),this.save(),!0)}remove(e){this.comments=this.comments.filter(t=>t.id!==e),this.save()}getAll(){return this.comments}}const i=(e,t=document)=>t.querySelector(e),c=e=>e&&null!==e.offsetParent,s=e=>{for(const t of e){const e=i(t);if(c(e))return e}return null};function d(e){const t=i("#comments-list");if(!t)return;const n=e.getAll();n.length?t.innerHTML=n.map(e=>`\n<div class="comment-item" data-id="${e.id}">\n  <span class="comment-text">${e.text}</span>\n  <span class="comment-delete" data-id="${e.id}">\xd7</span>\n</div>`).join(""):t.innerHTML='<div class="empty-message">\u6682\u65e0\u5e38\u7528\u8bc4\u8bba<br>\u8bf7\u5148\u6dfb\u52a0</div>'}function l(e,t=5e3){return new Promise((n,o)=>{const r=s(e);if(r)return void n(r);const a=new MutationObserver(()=>{const t=s(e);t&&(clearTimeout(i),a.disconnect(),n(t))}),i=setTimeout(()=>{a.disconnect(),o(new Error("\u7b49\u5f85\u5143\u7d20\u8d85\u65f6"))},t);a.observe(document.body,{childList:!0,subtree:!0,attributes:!0,attributeFilter:["style","class"]})})}function m(){const e=new a;!function(){const e=document.createElement("style");e.textContent=`\n#linuxdo-float-bar{position:fixed;right:16px;top:50%;transform:translateY(-50%);width:40px;background:rgba(255,255,255,.95);border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.1);padding:6px;z-index:9999;display:flex;flex-direction:column;gap:6px}\n.linuxdo-btn{width:${t};height:${t};border:none;border-radius:8px;background:#f0f0f0;color:#333;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;transition:all .2s}\n.linuxdo-btn:hover{background:#e0e0e0;transform:scale(1.08)}\n#linuxdo-comments-panel{position:fixed;right:80px;top:50%;transform:translateY(-50%);width:280px;max-height:480px;background:#fff;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,.15);z-index:9998;display:none;flex-direction:column;overflow:hidden}\n#linuxdo-comments-panel.show{display:flex}\n.comments-panel-header{padding:12px 14px;border-bottom:1px solid #e8e8e8;display:flex;justify-content:space-between;align-items:center;font-weight:600;font-size:14px}\n.comments-panel-header span:last-child{cursor:pointer;opacity:.6;font-size:18px}\n.comments-panel-header span:last-child:hover{opacity:1}\n.comments-panel-body{flex:1;overflow-y:auto;padding:8px}\n.comments-panel-body::-webkit-scrollbar{width:6px}\n.comments-panel-body::-webkit-scrollbar-thumb{background:#ccc;border-radius:3px}\n.comment-item{padding:8px 10px;margin-bottom:6px;background:#f8f8f8;border-radius:6px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;transition:all .2s}\n.comment-item:hover{background:#ececec;transform:translateX(-2px)}\n.comment-text{flex:1;word-break:break-word;font-size:12px;color:#555;line-height:1.4}\n.comment-delete{color:#ff6b6b;cursor:pointer;padding:2px 6px;margin-left:8px;font-size:16px;opacity:.6}\n.comment-delete:hover{opacity:1}\n.comments-panel-footer{padding:8px;border-top:1px solid #e8e8e8}\n.add-comment-input{width:100%;padding:8px 10px;border:1px solid #e0e0e0;border-radius:6px;margin-bottom:6px;font-size:12px;box-sizing:border-box}\n.add-comment-input:focus{outline:none;border-color:#999}\n.add-comment-btn{width:100%;padding:8px;background:#333;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:500}\n.add-comment-btn:hover{background:#444}\n.empty-message{text-align:center;color:#999;padding:20px;font-size:12px}\n@media (prefers-color-scheme: dark){\n  #linuxdo-float-bar{background:rgba(30,30,30,.95)}\n  .linuxdo-btn{background:#2a2a2a;color:#e0e0e0}\n  .linuxdo-btn:hover{background:#3a3a3a}\n  #linuxdo-comments-panel{background:#1e1e1e}\n  .comments-panel-header{border-bottom-color:#333;color:#e0e0e0}\n  .comments-panel-body::-webkit-scrollbar-thumb{background:#444}\n  .comment-item{background:#2a2a2a}\n  .comment-item:hover{background:#333}\n  .comment-text{color:#ccc}\n  .comments-panel-footer{border-top-color:#333}\n  .add-comment-input{background:#2a2a2a;border-color:#444;color:#e0e0e0}\n  .add-comment-input:focus{border-color:#666}\n  .add-comment-btn{background:#4a4a4a}\n  .add-comment-btn:hover{background:#5a5a5a}\n  .empty-message{color:#666}\n}`,document.head.appendChild(e)}(),function(){const e=document.createElement("div");e.id="linuxdo-float-bar",e.innerHTML='\n<button class="linuxdo-btn" id="quick-comment-btn" title="\u5feb\u6377\u8bc4\u8bba">\u{1f4ac}</button>\n<button class="linuxdo-btn" id="back-to-top-btn" title="\u56de\u5230\u9876\u90e8">\u2b06\ufe0f</button>';const t=document.createElement("div");t.id="linuxdo-comments-panel",t.innerHTML='\n<div class="comments-panel-header">\n  <span>\u5e38\u7528\u8bc4\u8bba</span>\n  <span id="close-panel">\u2715</span>\n</div>\n<div class="comments-panel-body" id="comments-list"></div>\n<div class="comments-panel-footer">\n  <input type="text" class="add-comment-input" id="new-comment-input" placeholder="\u8f93\u5165\u65b0\u7684\u5e38\u7528\u8bc4\u8bba...">\n  <button class="add-comment-btn" id="add-comment-btn">\u6dfb\u52a0</button>\n</div>';const n=document.createDocumentFragment();n.appendChild(e),n.appendChild(t),document.body.appendChild(n)}(),d(e);const c=i("#linuxdo-comments-panel"),s=i("#quick-comment-btn"),m=i("#back-to-top-btn"),u=i("#close-panel"),p=i("#add-comment-btn"),b=i("#new-comment-input"),x=i("#comments-list");if(!(c&&s&&m&&u&&p&&b&&x))return;let f=null,h=!1;const g=()=>clearTimeout(f),v=(e,t)=>{f=setTimeout(()=>{t()&&c.classList.remove("show")},e)},y=()=>{s.style.display=i("#current-user, .current-user")?"flex":"none"};y();let k=null;new MutationObserver(()=>{k||(k=setTimeout(()=>{y(),k=null},500))}).observe(document.body,{childList:!0,subtree:!0}),s.addEventListener("mouseenter",()=>{g(),c.classList.add("show")}),s.addEventListener("mouseleave",()=>v(200,()=>!c.matches(":hover")&&!h)),c.addEventListener("mouseenter",g),c.addEventListener("mouseleave",()=>v(100,()=>!h)),b.addEventListener("focus",()=>{h=!0,g()}),b.addEventListener("blur",()=>{h=!1,v(200,()=>!c.matches(":hover"))}),u.addEventListener("click",()=>c.classList.remove("show")),m.addEventListener("click",()=>window.scrollTo({top:0,behavior:"smooth"})),p.addEventListener("click",()=>{e.add(b.value)&&(b.value="",d(e))}),b.addEventListener("keypress",e=>{"Enter"===e.key&&p.click()}),x.addEventListener("click",t=>{const a=t.target.closest(".comment-delete");if(a)return e.remove(parseInt(a.dataset.id,10)),void d(e);const s=t.target.closest(".comment-item");if(!s)return;const m=parseInt(s.dataset.id,10),u=e.getAll().find(e=>e.id===m);u&&(async function(e){try{const t=(e=>{for(const t of e){const e=i(t);if(e)return e}return null})(n);if(!t)return void alert("\u672a\u627e\u5230\u56de\u590d\u6309\u94ae\uff0c\u8bf7\u786e\u4fdd\u5728\u5e16\u5b50\u9875\u9762");t.click();const a=await l(o,5e3);a.value=e,a.focus(),function(e){["input","change","keyup"].forEach(t=>{e.dispatchEvent(new Event(t,{bubbles:!0,cancelable:!0}))})}(a),await new Promise(e=>setTimeout(e,300)),(await l(r,3e3)).click()}catch(e){console.error("\u53d1\u9001\u8bc4\u8bba\u5931\u8d25:",e),alert("\u53d1\u9001\u8bc4\u8bba\u5931\u8d25: "+e.message)}}(u.text),c.classList.remove("show"))})}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",m):m()}();
